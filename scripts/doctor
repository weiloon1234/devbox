#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
GEN="$ROOT/generated/workspaces"
MOUNT_BASE="${DEVBOX_MOUNT_BASE:-$HOME/DevboxMount}"

ok(){ echo "✅ $*"; }
warn(){ echo "⚠️  $*"; }
bad(){ echo "❌ $*"; }

has_cmd(){ command -v "$1" >/dev/null 2>&1; }

source "$ROOT/scripts/lib/ws-meta.sh"

echo "=== devbox doctor ==="
echo "root: $ROOT"
echo "mount base: $MOUNT_BASE"
echo

# Homebrew
if has_cmd brew; then ok "brew installed"; else warn "brew missing (recommended)"; fi

# Docker Desktop (macOS-specific check)
if [[ -d "/Applications/Docker.app" ]]; then
  ok "Docker Desktop app installed"
else
  warn "Docker Desktop app not found at /Applications/Docker.app"
fi

# Docker CLI + daemon
DOCKER_OK=0
if has_cmd docker; then
  ok "docker CLI installed"
  if docker info >/dev/null 2>&1; then
    ok "docker daemon running"
    DOCKER_OK=1
  else
    bad "docker daemon NOT running (open Docker Desktop)"
  fi
else
  bad "docker CLI missing (install Docker Desktop)"
fi

# mkcert
if has_cmd mkcert; then
  ok "mkcert installed"
  if mkcert -CAROOT >/dev/null 2>&1; then
    ok "mkcert CAROOT available"
  else
    warn "mkcert CAROOT check failed"
  fi
else
  warn "mkcert missing (HTTPS for *.test will fail)"
fi

# TLS cert presence (global, once)
echo
echo "--- TLS ---"
CRT="$ROOT/proxy/certs/local.test.crt"
KEY="$ROOT/proxy/certs/local.test.key"
if [[ -f "$CRT" && -f "$KEY" ]]; then
  ok "TLS cert present: proxy/certs/local.test.(crt|key)"
else
  warn "TLS cert missing (re-run ./scripts/install to auto-generate)"
fi

# DNS wildcard (.test) (global, once)
echo
echo "--- DNS (.test wildcard) ---"
if has_cmd dnsmasq; then
  if ps aux | grep -v grep | grep -q dnsmasq; then
    ok "dnsmasq running (*.test resolves)"
  else
    warn "dnsmasq installed but not running"
  fi
else
  warn "dnsmasq not installed (*.test will not resolve)"
fi

# sshfs / macFUSE
echo
echo "--- Mount tooling ---"
if has_cmd sshfs; then
  ok "sshfs available"
else
  warn "sshfs missing (mount helpers won't work)"
  warn "macOS: install via macFUSE + sshfs-mac (gromgit/fuse/sshfs-mac)"
fi

if [[ -d "/Library/Filesystems/macfuse.fs" ]] || [[ -d "/Library/Filesystems/osxfuse.fs" ]]; then
  ok "macFUSE appears installed"
else
  warn "macFUSE not detected (sshfs may fail)"
fi

# Docker networks
echo
echo "--- Docker networks ---"
if [[ "$DOCKER_OK" -eq 1 ]]; then
  if docker network inspect proxy >/dev/null 2>&1; then ok "network: proxy"; else warn "network missing: proxy (run devbox-bootstrap)"; fi
  if docker network inspect devbox >/dev/null 2>&1; then ok "network: devbox"; else warn "network missing: devbox (run devbox-bootstrap)"; fi
else
  warn "skipping network checks (docker not running)"
fi

# Core containers
echo
echo "--- Core containers ---"
if [[ "$DOCKER_OK" -eq 1 ]]; then
  for c in devbox-traefik devbox-mysql devbox-postgres devbox-redis; do
    if docker ps --format '{{.Names}}' | grep -qx "$c"; then
      ok "running: $c"
    else
      warn "not running: $c"
    fi
  done
else
  warn "skipping container checks (docker not running)"
fi

# Workspaces
echo
echo "--- Workspaces ---"
if [[ ! -d "$GEN" ]]; then
  warn "no generated/workspaces folder (expected if none created yet)"
  echo "Create one with: devbox-ws-new"
  echo "=== doctor done ==="
  exit 0
fi

shopt -s nullglob
ws_count=0
for wsdir in "$GEN"/*; do
  [[ -d "$wsdir" ]] || continue
  ws="$(basename "$wsdir")"
  compose="$wsdir/docker-compose.yml"

  if [[ ! -f "$compose" ]]; then
    warn "workspace '$ws': missing docker-compose.yml"
    continue
  fi

  ws_count=$((ws_count+1))

  if ws_load_meta "$ws" 2>/dev/null; then
    port="$SSH_PORT"
  else
    port="?"
  fi

  echo "Workspace: $ws (ssh port: $port)"

  # Containers per workspace (only if docker running)
  if [[ "$DOCKER_OK" -eq 1 ]]; then
    for c in "ws-$ws" "ws-$ws-nginx" "ws-$ws-php81" "ws-$ws-php82" "ws-$ws-php83" "ws-$ws-php84" "ws-$ws-php85"; do
      if docker ps --format '{{.Names}}' | grep -qx "$c"; then
        ok "  running: $c"
      else
        warn "  not running: $c"
      fi
    done
  else
    warn "  skipping container checks (docker not running)"
  fi

  # Port check
  if [[ "$port" != "?" ]]; then
    if lsof -nP -iTCP:"$port" -sTCP:LISTEN >/dev/null 2>&1; then
      ok "  ssh port listening on localhost:$port"
    else
      warn "  ssh port NOT listening on localhost:$port"
    fi
  fi

  # Mount check
  mp="$MOUNT_BASE/$ws"
  if [[ -d "$mp" ]] && mount | grep -q "on ${mp} "; then
    ok "  mounted: $mp"
  else
    warn "  not mounted: $mp (use: devbox-mount $ws)"
  fi

  echo
done
shopt -u nullglob

if [[ $ws_count -eq 0 ]]; then
  warn "no workspaces found under generated/workspaces"
  echo "Create one with: devbox-ws-new"
fi

echo "=== doctor done ==="