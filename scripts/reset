#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

echo "[devbox] stopping generated workspaces..."
GEN_ROOT="$ROOT/generated/workspaces"
if [[ -d "$GEN_ROOT" ]]; then
  shopt -s nullglob
  for compose in "$GEN_ROOT"/*/docker-compose.yml; do
    [[ -f "$compose" ]] || continue
    docker compose -f "$compose" down || true
  done
  shopt -u nullglob
fi

echo "[devbox] stopping shared db..."
docker compose -f "$ROOT/db/docker-compose.yml" down || true

echo "[devbox] stopping proxy..."
docker compose -f "$ROOT/proxy/docker-compose.yml" down || true

echo "[devbox] removing workspace code volumes (dev_ws_*_code)..."
WS_VOLS="$(docker volume ls -q | grep -E '^dev_ws_.*_code$' || true)"
if [[ -n "$WS_VOLS" ]]; then
  # shellcheck disable=SC2086
  docker volume rm -f $WS_VOLS 2>/dev/null || true
fi

echo "[devbox] removing shared db volumes..."
docker volume rm -f devbox_mysql devbox_pg devbox_redis 2>/dev/null || true

echo "[devbox] reset complete."
echo "Next:"
echo "  ./scripts/bootstrap"
echo "  ./scripts/workspace-new"