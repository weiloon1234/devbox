#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
GEN="$ROOT/generated/workspaces"

fail(){ echo "ERROR: $*" >&2; exit 1; }

[[ -d "$GEN" ]] || { echo "(no generated workspaces)"; exit 0; }

[[ "${DEVBOX_MOUNT_BASE:-$HOME/DevboxMount}" == "$HOME/"* ]] || fail "DEVBOX_MOUNT_BASE must live under \$HOME"

shopt -s nullglob
for d in "$GEN"/*; do
  [[ -d "$d" ]] || continue
  ws="$(basename "$d")"
  "$ROOT/scripts/ws-mount" "$ws" || true
done
shopt -u nullglob