#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
GEN_ROOT="$ROOT/generated/workspaces"

source "$ROOT/scripts/lib/ws-meta.sh"

printf "%-20s %-10s %-35s\n" "WORKSPACE" "SSH_PORT" "COMPOSE"
printf "%-20s %-10s %-35s\n" "---------" "--------" "------"

if [[ ! -d "$GEN_ROOT" ]]; then
  echo "(no generated workspaces folder)"
  exit 0
fi

shopt -s nullglob
FOUND=0
for wsdir in "$GEN_ROOT"/*/; do
  [[ -d "$wsdir" ]] || continue
  ws="$(basename "$wsdir")"

  if ws_load_meta "$ws" 2>/dev/null; then
    port="$SSH_PORT"
  else
    port="?"
  fi

  printf "%-20s %-10s %-35s\n" "$ws" "$port" "generated/workspaces/$ws/docker-compose.yml"
  FOUND=$((FOUND+1))
done
shopt -u nullglob

if [[ $FOUND -eq 0 ]]; then
  echo "(no workspaces found)"
fi
