#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
GEN_ROOT="$ROOT/generated/workspaces"

printf "%-20s %-10s %-35s\n" "WORKSPACE" "SSH_PORT" "COMPOSE"
printf "%-20s %-10s %-35s\n" "---------" "--------" "------"

if [[ ! -d "$GEN_ROOT" ]]; then
  echo "(no generated workspaces folder)"
  exit 0
fi

shopt -s nullglob
FOUND=0
for compose in "$GEN_ROOT"/*/docker-compose.yml; do
  ws="$(basename "$(dirname "$compose")")"
  port="$(grep -E '^\s*-\s*"127\.0\.0\.1:[0-9]+:22"' "$compose" \
    | head -n1 \
    | sed -E 's/.*127\.0\.0\.1:([0-9]+):22.*/\1/')"

  [[ -n "$port" ]] || port="?"

  printf "%-20s %-10s %-35s\n" "$ws" "$port" "generated/workspaces/$ws/docker-compose.yml"
  FOUND=$((FOUND+1))
done
shopt -u nullglob

if [[ $FOUND -eq 0 ]]; then
  echo "(no workspaces found)"
fi