#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
GEN="$ROOT/generated/workspaces"
MOUNT_BASE="${DEVBOX_MOUNT_BASE:-$HOME/DevboxMount}"

NO_MOUNT=0
if [[ "${1:-}" == "--no-mount" ]]; then
  NO_MOUNT=1
fi

fail(){ echo "ERROR: $*" >&2; exit 1; }
ok(){ echo "✅ $*"; }
warn(){ echo "⚠️  $*"; }

has_cmd(){ command -v "$1" >/dev/null 2>&1; }

ok "Starting core infra..."
"$ROOT/scripts/bootstrap"

if [[ ! -d "$GEN" ]]; then
  warn "No generated workspaces folder: $GEN"
  warn "Create a workspace first: devbox-ws-new"
  exit 0
fi

# Enumerate workspaces
shopt -s nullglob
WS_DIRS=("$GEN"/*)
shopt -u nullglob

if [[ ${#WS_DIRS[@]} -eq 0 ]]; then
  warn "No workspaces found under: $GEN"
  warn "Create one: devbox-ws-new"
  exit 0
fi

ok "Found workspaces:"
for wsdir in "${WS_DIRS[@]}"; do
  [[ -d "$wsdir" ]] || continue
  ws="$(basename "$wsdir")"
  echo "  - $ws"
done

ok "Starting all workspaces..."
for wsdir in "${WS_DIRS[@]}"; do
  [[ -d "$wsdir" ]] || continue
  ws="$(basename "$wsdir")"
  compose="$wsdir/docker-compose.yml"
  if [[ ! -f "$compose" ]]; then
    warn "  $ws: missing docker-compose.yml (skipping)"
    continue
  fi
  ok "  up: $ws"
  docker compose -f "$compose" up -d
done

if [[ "$NO_MOUNT" -eq 1 ]]; then
  ok "Skip mount (--no-mount). Done."
  exit 0
fi

# Mount requires sshfs
if ! has_cmd sshfs; then
  warn "sshfs not found; skipping mounts"
  warn "You can still work via SSH only: devbox-ws-ssh <ws>"
  warn "Install sshfs-mac: brew install gromgit/fuse/sshfs-mac (and macfuse)"
  exit 0
fi

mkdir -p "$MOUNT_BASE"
ok "Mount base: $MOUNT_BASE"

ok "Mounting all workspaces..."
for wsdir in "${WS_DIRS[@]}"; do
  [[ -d "$wsdir" ]] || continue
  ws="$(basename "$wsdir")"
  compose="$wsdir/docker-compose.yml"
  [[ -f "$compose" ]] || continue

  port="$(grep -E '^\s*-\s*"127\.0\.0\.1:[0-9]+:22"' "$compose" \
    | head -n1 \
    | sed -E 's/.*127\.0\.0\.1:([0-9]+):22.*/\1/')"
  if [[ -z "$port" ]]; then
    warn "  $ws: cannot detect ssh port (skipping mount)"
    continue
  fi

  key="$HOME/.ssh/${ws}_id_ed25519"
  if [[ ! -f "$key" ]]; then
    warn "  $ws: missing private key: $key (skipping mount)"
    continue
  fi

  mp="$MOUNT_BASE/$ws"
  mkdir -p "$mp"

  if mount | grep -q "on ${mp} "; then
    ok "  $ws: already mounted at $mp"
    continue
  fi

  SSH_USER="ubuntu"

  ok "  mount: $ws (ssh :$port) -> $mp"
  sshfs \
    -p "$port" \
    -o reconnect,ServerAliveInterval=15,ServerAliveCountMax=3 \
    -o IdentityFile="$key" \
    -o IdentitiesOnly=yes \
    -o StrictHostKeyChecking=accept-new \
    "${SSH_USER}@127.0.0.1:/workspace" \
    "$mp"
done

ok "All done. Open Finder: $MOUNT_BASE"