#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
GEN="$ROOT/generated/workspaces"
MOUNT_BASE="${DEVBOX_MOUNT_BASE:-$HOME/DevboxMount}"

NO_MOUNT=0
if [[ "${1:-}" == "--no-mount" ]]; then
  NO_MOUNT=1
fi

fail(){ echo "ERROR: $*" >&2; exit 1; }
ok(){ echo "✅ $*"; }
warn(){ echo "⚠️  $*"; }

ok "Starting core infra..."
"$ROOT/scripts/bootstrap"

if [[ ! -d "$GEN" ]]; then
  warn "No generated workspaces folder: $GEN"
  warn "Create a workspace first: devbox-ws-new"
  exit 0
fi

# Enumerate workspaces
shopt -s nullglob
WS_DIRS=("$GEN"/*)
shopt -u nullglob

if [[ ${#WS_DIRS[@]} -eq 0 ]]; then
  warn "No workspaces found under: $GEN"
  warn "Create one: devbox-ws-new"
  exit 0
fi

ok "Found workspaces:"
for wsdir in "${WS_DIRS[@]}"; do
  [[ -d "$wsdir" ]] || continue
  ws="$(basename "$wsdir")"
  echo "  - $ws"
done

ok "Starting all workspaces..."
for wsdir in "${WS_DIRS[@]}"; do
  [[ -d "$wsdir" ]] || continue
  ws="$(basename "$wsdir")"
  compose="$wsdir/docker-compose.yml"
  if [[ ! -f "$compose" ]]; then
    warn "  $ws: missing docker-compose.yml (skipping)"
    continue
  fi
  ok "  up: $ws"
  docker compose -f "$compose" up -d
done

if [[ "$NO_MOUNT" -eq 1 ]]; then
  ok "Skip mount (--no-mount). Done."
  exit 0
fi

"$ROOT/scripts/ws-mount-all"

ok "All done. Open Finder: $MOUNT_BASE"